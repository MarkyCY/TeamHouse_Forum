var g_cfg={},oldNetMode=false,views={netmode:{headerId:"#headerNetmode",init:function(){var a=this;this.cfgBackup={};$("#netmode").change(function(){var e=$(this).val(),d=g_cfg,c=g_net.evFns;$("#network").trigger("beforeSubmit");if(a.cfgBackup[e]){g_cfg=a.cfgBackup[e]}else{g_cfg=g_net.switchNetmode(e)}a.cfgBackup[d.netmode]=d;g_net=ubnt.net.network(g_cfg);g_cfg.netconf.each(function(f,h){var g=d.netconf.findByDevname(h.devname);if(g){h.mtu=g.mtu}else{if(h.devname.indexOf("br")==0){h.mtu=g_net.getMaxMtu(h.devname)}}},true);if(!oldNetMode){oldNetMode=d.netmode}g_net.evFns=c;renderViews()})},render:function(){}},disableNet:{init:function(){$("#network").bind("beforeSubmit",function(){var d=$("#disableNet").val(),a=g_net.isBridge?"":g_net.wan.getDevname(),c=[];if(d=="eth0/eth1"){c=["eth0","eth1"]}else{if(d=="eth1/ath0"){c=["eth1","ath0"]}else{c.push(d)}}g_cfg.netconf.each(function(f,e){var h=$.inArray(e.devname,c)==-1;if(h&&g_net.isBridge&&e.up=="disabled"){var i=g_cfg.bridge.objs[0],g=i&&i.port.findByDevname(e.devname);if(g&&i.canHavePort(g.devname)){g.enabled(true)}}e.up=h?"enabled":"disabled"})})},render:function(){var e=g_cfg.getInterfaces(["board"]),d=g_net.isBridge?"":g_net.wan.getDevname(),a=g_cfg.netconf.find({status:"enabled",up:"disabled"}),g=$("#disableNet"),f="None",c=g_cfg.netmode=="soho";if(a.length==1){f=a[0].devname}else{if(a.length==2){if(c){f="eth1/ath0"}else{f="eth0/eth1"}}}g.children().remove();e.sort();if(c){e.push("eth1/ath0")}else{if($.inArray("eth1",e)!=-1){e.push("eth0/eth1")}}g.append($("<option></option>").prop("selected",f=="None").attr("value","None").text(jsTranslate("None")));$.each(e,function(h,i){g.append($("<option></option>").prop("selected",i==f).attr("value",i).text(ubnt.cfg.devname2uidevname(ubnt.cfg.devname2uidevname(i))))})}},ifaces:{headerId:"#headerIfaces",init:function(){var a=function(g,k,j){var f=g_net.getMaxMtu(g);var i=jsTranslate("warn_mtu|MTU value must be in range [64-")+f+"].";var h=parseInt(k);if(!$.isNumeric(k)||(h<64||h>f)){j.push(i);return false}return true};var c=$("#iface_table > tbody")[0],d=this,e=$("#ifaceErrDiv");$("#iface_table").delegate("input.editIface","click",function(){var f=$.tmplItem(this).data;$(this).closest("tr").replaceWith($("#ifaceEditTmpl").tmpl([f]));$("#ifaceMtu").prop("title","[64-"+g_net.getMaxMtu(f.devname)+"]");$(".editIface").disable()}).delegate("input.cancelIface","click",function(){var f=$.tmplItem(this).data;$(this).closest("tr").replaceWith($("#ifaceTmpl").tmpl([f]));d.render()}).delegate("input.saveIface","click",function(){var i=$.tmplItem(this).data,g=$("#ifaceMtu").val(),h=[];if(a(i.devname,g,h)){g_cfg.netconf.findByDevname(i.devname,true).mtu=g;i.mtu=g;$(this).closest("tr").replaceWith($("#ifaceTmpl").tmpl([i]));if(g_cfg.netmode!="bridge"){if(i.devname==g_net.wan.getDevname()){var f=g_net.getWanMaxMtu(i.devname);$("#wanPppoeMtu").prop("title","[64-"+f+"]");$("#wanPppoeMru").prop("title","[64-"+f+"]")}}d.render()}showErrors(e,h)});g_net.bind("ifcAdded ifcRemoved ifcEnabled ifcDisabled",$.proxy(this,"render"))},valid:function(){var f=$("#ifaceSettings"),c=true,e=f.find(".iMtu"),d=$("#ifaceErrDiv"),a=[];e.each(function(h){var j=e[h].innerHTML,g=f.find(".iDevname")[h].innerHTML,k=g_net.getMaxMtu(ubnt.cfg.uidevname2devname(g));if(parseInt(j)>parseInt(k)){a.push(g+jsTranslate(" MTU value must be in range [64-")+k+"].")}});showErrors(d,a);c=a.length==0;return c},render:function(){var a=$.grep(g_cfg.netconf.objs,function(c){return c.enabled()});a.sort(function(d,e){var c=ubnt.cfg.devname2uidevname(d.devname);b=ubnt.cfg.devname2uidevname(e.devname);if(c==b){return 0}else{if(c<b){return -1}else{return 1}}});$("#iface_table > tbody > tr").remove();$("#ifaceTmpl").tmpl(a).appendTo("#iface_table")}},vlan:{headerId:"#headerVlan",init:function(){var a=$("#vlan_table > tbody")[0],d=$("#vlanErrDiv"),c=this;$("#vlan_table").delegate("input.enableVlan","change",function(){var e=$.tmplItem(this).data,f=this.checked;e.enabled(f);g_net.enableIfc(e.getFullDevname(),f)}).delegate("input.editVlan","click",function(){$("#vlan_table").find(".editVlan, #vlanAdd").prop("disabled",true);var e=$.tmplItem(this).data;$(this).closest("tr").replaceWith($("#vlanEditTmpl").tmpl([e]));c.ifcChanged()}).delegate("input.saveVlan","click",function(){var e=$.tmplItem(this).data;e.comment=$("#edtVlanComment").val();$(this).closest("tr").replaceWith($("#vlanTmpl").tmpl([e]));$("#vlan_table").find(".editVlan, #vlanAdd").prop("disabled",false);c.ifcChanged()}).delegate("input.delVlan","click",function(){var e=$.tmplItem(this).data;g_net.removeVlan(e);if($(this).closest("tr").find("#edtVlanComment").length>0){$("#vlan_table").find(".editVlan, #vlanAdd").prop("disabled",false)}$(this).closest("tr").remove();$("#vlan_table").trigger("vlanDel",e.getFullDevname())});$("#vlanAdd").click(function(){var f=g_cfg.get("vlan"),e=f.create($("#vlanIfc").val(),$("#vlanId").val(),$("#vlanComment").val(),true),g=[];if(e.valid(g)){if(f.find({devname:e.devname,id:e.id}).length){g.push(jsTranslate("VLAN already exists."))}else{g_net.addVlan(e);$("#vlan_table tfoot input[type=text]").val("");$("#vlanTmpl").tmpl(e).appendTo("#vlan_table");$("#vlan_table").trigger("vlanAdd",e.getFullDevname())}}showErrors(d,g)});g_net.bind("ifcUsed",this.ifcChanged).bind("ifcUnused",this.ifcChanged)},render:function(){var a=g_cfg.get("vlan");$("#vlanIfc").children().remove();$.each(g_cfg.getInterfaces(["board"]),function(c,d){$("#vlanIfc").append($("<option></option>").attr("value",d).text(ubnt.cfg.devname2uidevname(d)))});$("#vlan_table > tbody > tr").remove();$("#vlanTmpl").tmpl(a.objs).appendTo("#vlan_table");this.ifcChanged()},ifcChanged:function(){$("#vlan_table > tbody > tr").each(function(c){var e=$(this),a=e.tmplItem().data.getFullDevname(),d=$.inArray(a,g_net.freeIfc)==-1;e.find("input.enableVlan").prop("disabled",d);e.find("input.delVlan").prop("disabled",d)})}},bridge:{headerId:"#headerBridge",init:function(){var a=this;$("#bridgeAdd").click(function(){var c=g_net.addBridge();$("#bridgeTmpl").tmpl(c).appendTo("#bridge_table");a.updateAddBridgePortSelect();$("#bridge_table").trigger("bridgeAdd",c.getDevname())});$("#bridge_table").delegate("input.enableBridge","change",function(){var c=$.tmplItem(this).data,d=this.checked;c.enabled(d);g_net.enableIfc(c.devname,d)}).delegate("input.enableBridgeStp","change",function(){var c=$.tmplItem(this).data;c.stp.enabled(this.checked)}).delegate("input.delBridge","click",function(){var c=$.tmplItem(this).data;g_net.removeBridge(c);$(this).closest("tr").remove();a.updateAddBridgePortSelect()}).delegate("select.addBridgePort","change",function(){var d=$(this).val(),c=$.tmplItem(this).data;if(d=="add"){return}if(g_net.addBridgePort(c,d)!=null){$(this).siblings("select.bridgePortList").append($("<option></option>").attr("value",d).text(ubnt.cfg.devname2uidevname(d)));$(this).val("add");a.updateAddBridgePortSelect()}}).delegate("input.delBridgePort","click",function(){var c=$.tmplItem(this).data,d=$(this).siblings("select.bridgePortList").children("option:selected");d.each(function(e,f){g_net.removeBridgePort(c,f.value)});d.remove();a.updateAddBridgePortSelect()});g_net.bind("ifcUnused",function(d,c){a.updateAddBridgePortSelect()}).bind("ifcUsed",function(d,c){});g_net.bind("ifcUsed ifcUnused",this.ifcChanged).bind("ifcUsed ifcUnused ifcEnabled ifcDisabled",this.updateAddBridgePortSelect);$("#network").bind("beforeSubmit",function(){if(!a.active){return}$("#bridge_table .comment").each(function(){var c=$.tmplItem(this).data;c.comment=$(this).val()})})},render:function(){$("#bridge_table > tbody > tr").remove();$("#bridgeTmpl").tmpl(g_cfg.bridge.objs).appendTo("#bridge_table");this.updateAddBridgePortSelect();this.ifcChanged()},valid:function(){var a=[];g_cfg.bridge.each(function(d,c){if(c.port.objs.length==0){a.push(ubnt.cfg.devname2uidevname(c.devname)+" "+jsTranslate("cannot be empty."))}});showErrors($("#bridgeErrDiv"),a);return(a.length==0)},updateAddBridgePortSelect:function(){var a=g_net.availableIfcsForBridgePors();$("#bridge_table select.addBridgePort").each(function(){var c=$.tmplItem(this).data,e=$.grep(a,$.proxy(c,"canHavePort")).sort(),d=$(this);d.children('option[value!="add"]').remove();$.each(filterEnabledIfcs(e),function(f,g){d.append($("<option></option>").attr("value",g).text(ubnt.cfg.devname2uidevname(g)))})})},ifcChanged:function(){$("#bridge_table > tbody > tr").each(function(a){var e=$(this),c=e.tmplItem().data.getDevname(),d=$.inArray(c,g_net.freeIfc)==-1;e.find("input.enableBridge").prop("disabled",d);e.find("input.delBridge").prop("disabled",d)})}},firewall:{headerId:"#headerFirewall",getTable:function(){return(g_cfg.netmode!="bridge")?"iptables":"ebtables"},getFw:function(a){return g_cfg[a]?g_cfg[a]:g_cfg.get(a)},getRules:function(){var a=this.getTable();var d=this.getFw(a);var c;if(a=="ebtables"){c=$.grep(d.objs,function(e){return !Firewall.isProtoIp6(e._proto)})}else{c=d.objs}return c},init:function(){var d=this,e=$("#fwErrDiv");var c=function(f){if(f&&f.indexOf("/")==-1){f+=f==="0.0.0.0"?"/0":"/32"}return f},a=function(g,f){var h={devname:$("#"+g+"Ifc").val(),proto:"0x0800",ipProto:$("#"+g+"Proto").val(),src:c($("#"+g+"SrcIp").val()),sport:$("#"+g+"SrcPort").val(),dst:c($("#"+g+"DstIp").val()),dport:$("#"+g+"DstPort").val(),src_inv:$("#"+g+"NotSrcIp").prop("checked"),sport_inv:$("#"+g+"NotSrcPort").prop("checked"),dst_inv:$("#"+g+"NotDstIp").prop("checked"),dport_inv:$("#"+g+"NotDstPort").prop("checked"),target:$("#"+g+"Target").val(),comment:$("#"+g+"Comment").val(),enabled:f};return h};$("#fw_table").delegate("input.delFwRule","click",function(){var g=$.tmplItem(this).data;d.fw.remove(g);var f=$(this).closest("tr");f.add($(f).nextUntil(".fwbase")).remove();if(f.find("#fweTarget").length>0){$("#fw_table").find(".editFwRule, #fwRuleAdd").prop("disabled",false)}showErrors(e)}).delegate("input.editFwRule","click",function(){$("#fw_table").find(".editFwRule, #fwRuleAdd").prop("disabled",true);var g=$.tmplItem(this).data;var f=$(this).closest("tr");f.add($(f).nextUntil(".fwbase")).replaceWith($("#fwEditRuleTmpl").tmpl([g]));$("#fweTarget").val(g._target);d.fillIfc($("#fweIfc"));$("#fweIfc").val(g._devname);d.fillProto($("#fweProto"));$("#fweProto").val(g._ipProto);$("#fweProto").change(function(){$(".fwe_port").disable($(this).val()<2)}).change()}).delegate("input.saveFwRule","click",function(){var i=$.tmplItem(this).data;var g=d.fw.create(a("fwe",i.enabled));var h=[];if(g.valid(h)){d.fw.replace(i,g);var f=$(this).closest("tr");f.add($(f).nextUntil(".fwbase")).replaceWith($("#fwRuleTmpl").tmpl([g]));$("#fw_table").find(".editFwRule, #fwRuleAdd").prop("disabled",false)}showErrors(e,h)}).delegate("input.enableFwRule","change",function(){$.tmplItem(this).data.enabled(this.checked)});$("#fwRuleAdd").click(function(){var f=d.fw.create(a("fw",true));var g=[];if(f.valid(g)){d.fw.add(f);$("#fwRuleTmpl").tmpl(f).appendTo("#fw_table");$("#fw_table tfoot input[type=text]").val("");$("#fw_table tfoot input[type=checkbox]").prop("checked",false);$("#fw_table tfoot select option:first-child").prop("selected",true)}showErrors(e,g)});$("#fwProto").change(function(){$(".fw_port").disable(!($(this).val()==6||$(this).val()==17))}).change();$("#fwEnable").change(function(){var f=this.checked;g_cfg.get(d.table+".sys.fw").enabled(f);if(f){g_cfg.get(d.table+".sys").enabled(true);g_cfg.get(d.table).enabled(true)}$("#fw_table").toggle(f)});g_net.bind("ifcAdded ifcRemoved ipModeChanged",$.proxy(this,"ifcChanged"))},render:function(){this.table=this.getTable();this.fw=this.getFw(this.table);var a=g_cfg.get(this.table+".sys.fw").enabled();$("#fw_table > tbody > tr").remove();$("#fwEnable").prop("checked",a);$("#fw_table").toggle(a);this.ifcChanged();if(this.fw){$("#fwRuleTmpl").tmpl(this.getRules()).appendTo("#fw_table")}this.fillProto($("#fwProto"))},fillProto:function(a){var c=[{v:"0",t:"IP"},{v:"1",t:"ICMP"},{v:"6",t:"TCP"},{v:"17",t:"UDP"}];if(this.table!="ebtables"){c.push({v:"p2p",t:"P2P"})}a.children().remove();$.each(c,function(d,e){a.append($("<option></option>").attr("value",e.v).text(e.t))})},fillIfc:function(c){var a=g_net.isBridge?g_cfg.bridge.getInterfaces():g_cfg.bridge.getPorts();c.children().remove();c.append($("<option></option>").attr("value","").text("ANY"));$.each(g_net.interfaces,function(d,e){if($.inArray(e,a)==-1){c.append($("<option></option>").attr("value",e).text(ubnt.cfg.devname2uidevname(e)))}});if(!g_net.isBridge&&g_net.wan.getIpMode()=="Pppoe"){c.append($("<option></option>").attr("value","ppp+").text(ubnt.cfg.devname2uidevname("ppp+")))}},ifcChanged:function(){this.fillIfc($("#fwIfc"))}},firewall6:{headerId:"#headerFirewall6",getTable:function(){return(g_cfg.netmode!="bridge")?"ip6tables":"ebtables"},getFw:function(a){return g_cfg[a]?g_cfg[a]:g_cfg.get(a)},getRules:function(){var a=this.getTable();var d=this.getFw(a);var c;if(a=="ebtables"){c=$.grep(d.objs,function(e){return Firewall.isProtoIp6(e._proto)})}else{c=d.objs}return c},init:function(){var d=this,e=$("#fw6ErrDiv");var c=function(f){if(f&&f.indexOf("/")==-1){f+="/64"}return f},a=function(g,f){var h={devname:$("#"+g+"Ifc").val(),proto:"0x86DD",ipProto:$("#"+g+"Proto").val(),src:c($("#"+g+"SrcIp").val()),sport:$("#"+g+"SrcPort").val(),dst:c($("#"+g+"DstIp").val()),dport:$("#"+g+"DstPort").val(),src_inv:$("#"+g+"NotSrcIp").prop("checked"),sport_inv:$("#"+g+"NotSrcPort").prop("checked"),dst_inv:$("#"+g+"NotDstIp").prop("checked"),dport_inv:$("#"+g+"NotDstPort").prop("checked"),target:$("#"+g+"Target").val(),comment:$("#"+g+"Comment").val(),enabled:f};return h};$("#fw6_table").delegate("input.delFwRule","click",function(){var g=$.tmplItem(this).data;d.fw.remove(g);var f=$(this).closest("tr");f.add($(f).nextUntil(".fwbase")).remove();if(f.find("#fweTarget").length>0){$("#fw6_table").find(".editFwRule, #fwRuleAdd").prop("disabled",false)}showErrors(e)}).delegate("input.editFwRule","click",function(){$("#fw6_table").find(".editFwRule, #fwRuleAdd").prop("disabled",true);var g=$.tmplItem(this).data;var f=$(this).closest("tr");f.add($(f).nextUntil(".fwbase")).replaceWith($("#fwEditRuleTmpl").tmpl([g]));$("#fweTarget").val(g._target);d.fillIfc($("#fweIfc"));$("#fweIfc").val(g._devname);d.fillProto($("#fweProto"));$("#fweProto").val(g._ipProto);$("#fweProto").change(function(){$(".fwe_port").disable($(this).val()<2)}).change()}).delegate("input.saveFwRule","click",function(){var i=$.tmplItem(this).data;var g=d.fw.create(a("fwe",i.enabled));var h=[];if(g.valid(h)){d.fw.replace(i,g);var f=$(this).closest("tr");f.add($(f).nextUntil(".fwbase")).replaceWith($("#fwRuleTmpl").tmpl([g]));$("#fw_table").find(".editFwRule, #fwRuleAdd").prop("disabled",false)}showErrors(e,h)}).delegate("input.enableFwRule","change",function(){$.tmplItem(this).data.enabled(this.checked)});$("#fw6RuleAdd").click(function(){var f=d.fw.create(a("fw6",true));var g=[];if(f.valid(g)){d.fw.add(f);$("#fwRuleTmpl").tmpl(f).appendTo("#fw6_table");$("#fw6_table tfoot input[type=text]").val("");$("#fw6_table tfoot input[type=checkbox]").prop("checked",false);$("#fw6_table tfoot select option:first-child").prop("selected",true)}showErrors(e,g)});$("#fwProto").change(function(){$(".fw_port").disable(!($(this).val()==6||$(this).val()==17))}).change();$("#fw6Enable").change(function(){var f=this.checked;g_cfg.get(d.table+".sys.fw6").enabled(f);if(f){g_cfg.get(d.table+".sys").enabled(true);g_cfg.get(d.table).enabled(true)}$("#fw6_table").toggle(f)});g_net.bind("ifcAdded ifcRemoved ipModeChanged",$.proxy(this,"ifcChanged"))},render:function(){this.table=this.getTable();this.fw=this.getFw(this.table);var a;a=g_cfg.get(this.table+".sys.fw6").enabled();$("#fw6_table > tbody > tr").remove();$("#fw6Enable").prop("checked",a);$("#fw6_table").toggle(a);this.ifcChanged();if(this.fw){$("#fwRuleTmpl").tmpl(this.getRules()).appendTo("#fw6_table")}this.fillProto($("#fw6Proto"))},fillProto:function(a){var c=[{v:"0",t:"IP"},{v:"58",t:"ICMP"},{v:"6",t:"TCP"},{v:"17",t:"UDP"}];a.children().remove();$.each(c,function(d,e){a.append($("<option></option>").attr("value",e.v).text(e.t))})},fillIfc:function(c){var a=g_net.isBridge?g_cfg.bridge.getInterfaces():g_cfg.bridge.getPorts();c.children().remove();c.append($("<option></option>").attr("value","").text("ANY"));$.each(g_net.interfaces,function(d,e){if($.inArray(e,a)==-1){c.append($("<option></option>").attr("value",e).text(ubnt.cfg.devname2uidevname(e)))}});if(!g_net.isBridge&&g_net.wan.getIpMode()=="Pppoe"){c.append($("<option></option>").attr("value","ppp+").text(ubnt.cfg.devname2uidevname("ppp+")))}},ifcChanged:function(){this.fillIfc($("#fw6Ifc"))}},routes:{headerId:"#headerRoutes",init:function(){var c=$("#routeErrDiv"),a=this;$("#route_table").delegate("input.delRoute","click",function(){var d=$.tmplItem(this).data;g_cfg.route.remove(d);if($(this).closest("tr").find("#edtIp").length>0){$("#route_table").find(".editRoute, #routeAdd").prop("disabled",false)}$(this).closest("tr").remove();showErrors(c)}).delegate("input.editRoute","click",function(){$("#route_table").find(".editRoute, #routeAdd").prop("disabled",true);var d=$.tmplItem(this).data;$(this).closest("tr").replaceWith($("#routeTmplEdit").tmpl([d]))}).delegate("input.saveRoute","click",function(){var e=$.tmplItem(this).data;var d=g_cfg.route.create($("#edtIp").val(),$("#edtNetmask").val(),$("#edtGateway").val(),$("#edtComment").val(),e.enabled);var f=[];if(d.valid(f)){g_cfg.route.replace(e,d);$(this).closest("tr").replaceWith($("#routeTmpl").tmpl([d]));$("#route_table").find(".editRoute, #routeAdd").prop("disabled",false)}showErrors(c,f)}).delegate("input.enableRoute","change",function(){$.tmplItem(this).data.enabled(this.checked)});$("#routeAdd").click(function(){var d=g_cfg.route.create($("#rtIp").val(),$("#rtNetmask").val(),$("#rtGateway").val(),$("#rtComment").val(),true);var e=[];if(d.valid(e)){g_cfg.route.add(d);$("#route_table tfoot input[type=text]").val("");$("#routeTmpl").tmpl(d).appendTo("#route_table")}showErrors(c,e)});$("#network").bind("beforeSubmit",function(){if(g_cfg.netmode!="bridge"){g_cfg.route.enabled(true)}})},render:function(){var a=g_cfg.route;$("#route_table > tbody > tr").remove();if(a){$("#routeTmpl").tmpl(a.objs.slice(1)).appendTo("#route_table")}}},routes6:{headerId:"#headerRoutes6",init:function(){var c=$("#route6ErrDiv"),a=this;$("#route6_table").delegate("input.delRoute","click",function(){var d=$.tmplItem(this).data;g_cfg.route6.remove(d);if($(this).closest("tr").find("#edtIp").length>0){$("#route6_table").find(".editRoute, #routeAdd").prop("disabled",false)}$(this).closest("tr").remove();showErrors(c)}).delegate("input.editRoute","click",function(){$("#route6_table").find(".editRoute, #routeAdd").prop("disabled",true);var d=$.tmplItem(this).data;$(this).closest("tr").replaceWith($("#routeTmplEdit").tmpl([d]))}).delegate("input.saveRoute","click",function(){var e=$.tmplItem(this).data;var d=g_cfg.route6.create($("#edtIp").val(),$("#edtNetmask").val(),$("#edtGateway").val(),$("#edtComment").val(),e.enabled);var f=[];if(d.valid(f)){g_cfg.route6.replace(e,d);$(this).closest("tr").replaceWith($("#routeTmpl").tmpl([d]));$("#route_table").find(".editRoute, #routeAdd").prop("disabled",false)}showErrors(c,f)}).delegate("input.enableRoute","change",function(){$.tmplItem(this).data.enabled(this.checked)});$("#route6Add").click(function(){var d=g_cfg.route6.create($("#rt6Ip").val(),$("#rt6Netmask").val(),$("#rt6Gateway").val(),$("#rt6Comment").val(),true);var e=[];if(d.valid(e)){g_cfg.route6.add(d);$("#route6_table tfoot input[type=text]").val("");$("#routeTmpl").tmpl(d).appendTo("#route6_table")}showErrors(c,e)});$("#network").bind("beforeSubmit",function(){if(g_cfg.netmode!="bridge"){g_cfg.route6.enabled(true)}})},render:function(){var a=g_cfg.get("route6",true);$("#route6_table > tbody > tr").remove();if(a){$("#routeTmpl").tmpl(a.objs.slice(1)).appendTo("#route6_table")}}},portForward:{headerId:"#headerPortFwd",init:function(){var c=this,d=$("#pfwdErrDiv");var a=function(e){if(e&&e.indexOf("/")==-1){e+=e==="0.0.0.0"?"/0":"/32"}return e};$("#pfwd_table").delegate("input.delPortFwd","click",function(){var e=$.tmplItem(this).data;if($(this).closest("tr").find("#edtHost").length>0){$("#pfwd_table").find(".editPortFwd, #pfwdAdd").prop("disabled",false)}c.portfw.remove(e);$(this).closest("tr").remove();showErrors(d)}).delegate("input.editPortFwd","click",function(){$("#pfwd_table").find(".editPortFwd, #pfwdAdd").prop("disabled",true);var e=$.tmplItem(this).data;$(this).closest("tr").replaceWith($("#portFwdTmplEdit").tmpl([e]));c.fillIfc($("#edtDevname"));$("#edtDevname").val(e.devname)}).delegate("input.savePortFwd","click",function(){var e=$.tmplItem(this).data,f=c.portfw.create($("#edtDevname").val(),$("#edtHost").val(),$("#edtPort").val(),$("#edtProto").val(),a($("#edtSrc").val()),a($("#edtDst").val()),$("#edtDport").val(),$("#edtComment").val(),e.enabled());var g=[];if(f.valid(g)){c.portfw.replace(e,f);$(this).closest("tr").replaceWith($("#portFwdTmpl").tmpl([f]));$("#pfwd_table").find(".editPortFwd, #pfwdAdd").prop("disabled",false)}showErrors(d,g)}).delegate("input.enablePortFwd","change",function(){$.tmplItem(this).data.enabled(this.checked)});$("#pfwdAdd").click(function(){var e=c.portfw.create($("#pfwdIfc").val(),$("#pfwdHost").val(),$("#pfwdPort").val(),$("#pfwdProto").val(),a($("#pfwdSrc").val()),a($("#pfwdDst").val()),$("#pfwdDport").val(),$("#pfwdComment").val(),true);var f=[];if(e.valid(f)){c.portfw.add(e);$("#pfwd_table tfoot input[type=text]").val("");$("#portFwdTmpl").tmpl(e).appendTo("#pfwd_table")}showErrors(d,f)});$("#network").bind("beforeSubmit",function(){if(!c.active){return}g_cfg.get("iptables").enabled(true);g_cfg.get("iptables.sys").enabled(true);c.portfw.enabled(c.portfw.objs.length>0)});g_net.bind("wanIfcChanged",function(){c.ifcChanged()})},render:function(){this.portfw=g_cfg.get("iptables.sys.portfw");$("#pfwd_table > tbody > tr").remove();this.ifcChanged();$("#portFwdTmpl").tmpl(this.portfw.objs).appendTo("#pfwd_table")},fillIfc:function(d){var c=g_net.isBridge?g_cfg.bridge.getInterfaces():g_cfg.bridge.getPorts();var a=g_net.isBridge?"":g_net.wan.getDevname();d.children().remove();$.each(g_net.interfaces,function(e,f){if($.inArray(f,c)==-1){d.append($("<option></option>").attr("value",f).text(ubnt.cfg.devname2uidevname(f)))}});if(!g_net.isBridge&&g_net.wan.getIpMode()=="Pppoe"){d.append($("<option></option>").attr("value","ppp+").text(ubnt.cfg.devname2uidevname("ppp+")))}d.val(a)},ifcChanged:function(){this.fillIfc($("#pfwdIfc"))}},aliases:{headerId:"#headerAliases",init:function(){var a=$("#aliasErrDiv");$("#alias_table").delegate("input.delAlias","click",function(){var d=$.tmplItem(this).data,c=g_cfg.netconf.findByDevname(d.devname,true);c.alias.remove(d.aliasObjRef);if($(this).closest("tr").find("#edtAliasIp").length>0){$("#alias_table").find(".editAlias, #aliasAdd").prop("disabled",false)}$(this).closest("tr").remove();showErrors(a)}).delegate("input.editAlias","click",function(){$("#alias_table").find(".editAlias, #aliasAdd").prop("disabled",true);var c=$.tmplItem(this).data;$(this).closest("tr").replaceWith($("#aliasEditTmpl").tmpl([c]))}).delegate("input.saveAlias","click",function(){var e=$.tmplItem(this).data,g=e.aliasObjRef,d=g_cfg.netconf.findByDevname(e.devname,true);var c=d.alias.create($("#edtAliasIp").val(),$("#edtAliasNetmask").val(),$("#edtAliasComment").val(),g.enabled());var f=[];if(c.valid(f)){d.alias.replace(g,c);e.aliasObjRef=c;$(this).closest("tr").replaceWith($("#aliasTmpl").tmpl([e]));$("#alias_table").find(".editAlias, #aliasAdd").prop("disabled",false)}showErrors(a,f)}).delegate("input.enableAlias","change",function(){$.tmplItem(this).data.aliasObjRef.enabled(this.checked)});$("#aliasAdd").click(function(){var c=g_cfg.netconf.findByDevname($("#aliasIfc").val(),true);if(c){var d={devname:c.devname,aliasObjRef:c.alias.create($("#aliasIp").val(),$("#aliasNetmask").val(),$("#aliasComment").val(),true)};var e=[];if(d.aliasObjRef.valid(e)){c.alias.add(d.aliasObjRef);$("#alias_table tfoot input[type=text]").val("");$("#aliasTmpl").tmpl(d).appendTo("#alias_table")}showErrors(a,e)}});g_net.bind("ifcUsed",$.proxy(this,"render")).bind("ifcUnused",this.fillDevnames)},render:function(){$("#alias_table > tbody").empty();this.fillDevnames();$("#aliasTmpl").tmpl(g_net.getIpAliases()).appendTo("#alias_table")},fillDevnames:function(){var c=g_cfg.bridge?g_cfg.bridge.getPorts():[],a=$.grep(g_net.interfaces,function(d){return $.inArray(d,c)==-1});$("#aliasIfc").children().remove();$.each(a,function(d,e){$("#aliasIfc").append($("<option></option>").attr("value",e).text(ubnt.cfg.devname2uidevname(e)))})}},wan:{headerId:"#headerWan",init:function(){var a=$("#wanIfc"),c=this;g_net.bind("ifcUsed ifcUnused ifcEnabled ifcDisabled",$.proxy(this,"updateWanIfc"));g_net.bind("bridgePortAdded bridgePortRemoved",$.proxy(this,"updateMaxMtuTooltip"));$("[name=wanIpMode]").click(function(){var d=$(this).val();$("#wanIp .initial_hide").hide();$("#wan"+d).show();g_net.wan.setIpMode(d,true);c.updateIp6(d);g_net.trigger("ipModeChanged")});$("[name=wanIp6Mode]").click(function(){var d=$(this).val();c.renderIp6(d);g_net.wan.setIp6Mode(d,true);g_net.trigger("ip6ModeChanged",d)});a.change(function(){var d=$(this).val();if(!g_net.advancedCfgMode()&&g_cfg.netmode=="router"){if(d!=g_net.wan.getDevname()){g_net.swapWanLanIfcs(d)}}else{g_net.setWanIfc($(this).val())}c.updateMaxMtuTooltip()});$("#wanPppoeMruNegotiation").click(function(){$("#wanPppoeMru").disable(!this.checked);$("#wanPppoeMru").val(this.checked?g_net.wan.getPppoe("mru"):"1500")});$("#wanNat").click(function(){$("#wanNatProtocols").toggle(this.checked)});$("#wanDmz").click(function(){$("#wanDmzSection").toggle(this.checked)});$("#wanChangeMac").click(function(){$("#wanChangeMacSection").toggle(this.checked)});$("#wanIp6Enable").click(function(){$("#wanIp6").toggle(this.checked)});$("#network").bind("beforeSubmit",function(){if(!c.active){return}var h=$("#wanSettings input:radio[name=wanIpMode]:checked").val(),k=$("#wanSettings input:radio[name=wanIp6Mode]:checked").val(),g=g_net.wan,f=$("#wanNat").prop("checked"),i=$("#wanDmz").prop("checked"),d=$("#wanBlockMgmt").prop("checked"),e=$("#wanChangeMac").prop("checked"),j=$("#wanIp6Enable").prop("checked");g.setIpMode(h,true);switch(h){case"Static":g.setIp($("#wanIpAddr").val(),$("#wanIpNetmask").val());g.setGateway($("#wanGateway").val());g.setDns(0,$("#wanDns1").val());g.setDns(1,$("#wanDns2").val());break;case"Dhcpc":g.setDhcpcFallback($("#wanDhcpcFallbackIp").val(),$("#wanDhcpcFallbackNetmask").val());break;case"Pppoe":g.setPppoe({name:$("#wanPppoeUser").val(),password:$("#wanPppoePassw").val(),pppoe_service:$("#wanPppoeService").val(),fallback:$("#wanPppoeFallbackIp").val(),fallback_netmask:$("#wanPppoeFallbackNetmask").val(),mtu:$("#wanPppoeMtu").val(),mru:$("#wanPppoeMru").val(),require:{mppe128:$("#wanPppoeEncryption").prop("checked")?"enabled":"disabled"},ipv6:{status:j?"enabled":"disabled"},mru_negotiation:$("#wanPppoeMruNegotiation").prop("checked")?"enabled":"disabled"});break}if(!g_net.advancedCfgMode()){g_net.setMtu(g_net.wan.getDevname(),$("#wanMtu").val())}g.natEnabled(f);if(f){g.natProtocolEnabled("sip",$("#wanNatSip").prop("checked"));g.natProtocolEnabled("pptp",$("#wanNatPptp").prop("checked"));g.natProtocolEnabled("ftp",$("#wanNatFtp").prop("checked"));g.natProtocolEnabled("rtsp",$("#wanNatRtsp").prop("checked"))}g.dmzEnabled(i);if(i){g.dmzObj.host=$("#wanDmzIp").val();g.dmzMgmtPortsEnabled(!$("#wanDmzMgmt").prop("checked"))}g.blockMgmt(d);g.netconfObj.hwaddr.enabled(e);if(e){g.netconfObj.hwaddr.mac=($("#wanMac").val())}g.netconfObj.autoip.enabled($("#wanAutoIp").prop("checked"));g.ip6Enable(j);if(j){g.setIp6Mode(k);if(k=="Ip6Static"){g.setIp6($("#wanIp6Addr").val(),$("#wanIp6Netmask").val());g.setIp6Gateway($("#wanIp6Gateway").val());g.setDns(2,$("#wanIp6Dns1").val());g.setDns(3,$("#wanIp6Dns2").val())}}else{g.setIp6Mode("Disabled")}})},render:function(){var a=g_net.advancedCfgMode();if(a||g_cfg.netmode=="router"){$("#wanIfcSection").show();this.updateWanIfc()}else{$("#wanIfcSection").hide()}$("input:radio[name=wanIpMode]").filter('[value="'+g_net.wan.getIpMode()+'"]').click();this.renderIp6(g_net.wan.getIp6Mode());this.fillData(g_net.wan);this.updateMaxMtuTooltip();this.updateWanMaxMtuTooltip()},renderIp6:function(a){$("input:radio[name=wanIp6Mode][value="+a+"]").prop("checked",true);$("#wanIp6 .initial_hide").hide();$("#wan"+a).show()},updateIp6:function(a){var d=a==="Pppoe";var c=$("#wanSettings input:radio[name=wanIp6Mode]:checked").val();$("#wanIp6ModeStatic").toggle(!d).next().toggle(!d);if(c==="Ip6Static"){c="Ip6Slaac";g_net.wan.setIp6Mode(c);this.renderIp6(c);g_net.trigger("ip6ModeChanged",c)}},valid:function(){var c=[],a=$("#wanSettings");ipMode=$("#wanSettings input:radio[name=wanIpMode]:checked").val(),ip6Mode=$("#wanSettings input:radio[name=wanIp6Mode]:checked").val(),dmzEnabled=$("#wanDmz").prop("checked"),changeMacEnabled=$("#wanChangeMac").prop("checked"),maxMtu=g_net.getMaxMtu(g_net.wan.getDevname()),maxWanMtu=g_net.getWanMaxMtu(g_net.wan.getDevname()),maxWanMru=$("#wanPppoeMruNegotiation").prop("checked")?maxWanMtu:1500,ip6Enabled=$("#wanIp6Enable").prop("checked");switch(ipMode){case"Static":validateFieds(a,[{name:jsTranslate("WAN IP"),field:"#wanIpAddr",req:true,valid:_validateNonZeroIP},{name:jsTranslate("WAN Netmask"),field:"#wanIpNetmask",req:true,valid:_validateNetmask},{name:jsTranslate("WAN Gateway IP"),field:"#wanGateway",req:true,valid:_validateNonZeroIP},{name:jsTranslate("Primary DNS IP"),field:"#wanDns1",req:true,valid:_validateNonZeroIP},{name:jsTranslate("Secondary DNS IP"),field:"#wanDns2",req:false,valid:_validateNonZeroIP},{name:jsTranslate("MTU"),field:"#wanMtu",req:true,min:64,max:maxMtu}],c);break;case"Dhcpc":validateFieds(a,[{name:jsTranslate("DHCP Fallback IP"),field:"#wanDhcpcFallbackIp",req:true,valid:_validateIP},{name:jsTranslate("DHCP Fallback Netmask"),field:"#wanDhcpcFallbackNetmask",req:true,valid:_validateNetmask},{name:jsTranslate("MTU"),field:"#wanMtu",req:true,min:64,max:maxMtu}],c);break;case"Pppoe":validateFieds(a,[{name:jsTranslate("PPPoE Fallback IP"),field:"#wanPppoeFallbackIp",req:false,valid:_validateIP},{name:jsTranslate("PPPoE Fallback Netmask"),field:"#wanPppoeFallbackNetmask",req:false,valid:_validateNetmask},{name:jsTranslate("PPPoE MTU"),field:"#wanPppoeMtu",req:true,min:64,max:maxWanMtu},{name:jsTranslate("PPPoE MRU"),field:"#wanPppoeMru",req:true,min:64,max:maxWanMru}],c);break}if(dmzEnabled){validateFieds(a,[{name:jsTranslate("DMZ IP"),field:"#wanDmzIp",req:true,valid:_validateNonZeroIP}],c)}if(changeMacEnabled){validateFieds(a,[{name:jsTranslate("MAC Address"),field:"#wanMac",req:true,valid:function(d){return/^([0-9A-F]{2}:?){5}[0-9A-F]{2}$/i.test(d)&&!/^(F{2}:?){5}F{2}$/i.test(d)}}],c)}if(ip6Enabled&&ip6Mode=="Ip6Static"){validateFieds(a,[{name:jsTranslate("WAN IPv6 Address"),field:"#wanIp6Addr",req:true,valid:_validateIP6},{name:jsTranslate("WAN IPv6 Netmask"),field:"#wanIp6Netmask",req:true,valid:_validateIP6Netmask},{name:jsTranslate("WAN IPv6 Gateway"),field:"#wanIp6Gateway",req:true,valid:_validateIP6},{name:jsTranslate("WAN IPv6 Primary DNS"),field:"#wanIp6Dns1",req:false,valid:_validateIP6},{name:jsTranslate("WAN IPv6 Secondary DNS"),field:"#wanIp6Dns2",req:false,valid:_validateIP6}],c)}showErrors(a.find(".errors"),c);return(c.length==0)},fillData:function(c){var d=c.ip6Enabled();$("#wanIpAddr").val(c.netconfObj.ip);$("#wanIpNetmask").val(c.netconfObj.netmask);$("#wanGateway").val(c.getGateway());$("#wanDns1").val(c.getDns(0));$("#wanDns2").val(c.getDns(1));$("#wanDhcpcFallbackIp").val(c.getDhcpcFallback());$("#wanDhcpcFallbackNetmask").val(c.getDhcpcFallbackNetmask());$("#wanPppoeUser").val(c.getPppoe("name"));$("#wanPppoePassw").val(c.getPppoe("password"));$("#wanPppoeService").val(c.getPppoe("pppoe_service"));$("#wanPppoeFallbackIp").val(c.getPppoe("fallback"));$("#wanPppoeFallbackNetmask").val(c.getPppoe("fallback_netmask"));$("#wanPppoeMtu").val(c.getPppoe("mtu"));$("#wanPppoeMru").val(c.getPppoe("mru"));$("#wanPppoeEncryption").prop("checked",c.pppObj&&c.pppObj.require&&c.pppObj.require.mppe128?c.pppObj.require.mppe128=="enabled":false);$("#wanPppoeMruNegotiation").prop("checked",c.getPppoe("mru_negotiation")=="disabled"?false:true);$("#wanPppoeMru").disable(c.getPppoe("mru_negotiation")=="disabled"?true:false);$("#wanMtuSection").toggle(c.ipMode!="Pppoe"&&!g_net.advancedCfgMode());$("#wanMtu").val(c.netconfObj.mtu);$("#wanNat").prop("checked",c.natEnabled());$("#wanNatProtocols").toggle(c.natEnabled());$("#wanNatSip").prop("checked",c.natProtocolEnabled("sip"));$("#wanNatPptp").prop("checked",c.natProtocolEnabled("pptp"));$("#wanNatFtp").prop("checked",c.natProtocolEnabled("ftp"));$("#wanNatRtsp").prop("checked",c.natProtocolEnabled("rtsp"));$("#wanAutoIp").prop("checked",c.netconfObj.autoip.enabled());$("#wanDmz").prop("checked",c.dmzEnabled());$("#wanDmzSection").toggle(c.dmzEnabled());$("#wanDmzMgmt").prop("checked",!c.dmzMgmtPortsEnabled());$("#wanDmzIp").val(c.dmzObj&&c.dmzObj.host?c.dmzObj.host:"");$("#wanBlockMgmt").prop("checked",c.blockMgmt());$("#wanChangeMac").prop("checked",c.netconfObj.hwaddr.enabled());$("#wanChangeMacSection").toggle(c.netconfObj.hwaddr.enabled());$("#wanMac").val(c.netconfObj.hwaddr&&c.netconfObj.hwaddr.mac?c.netconfObj.hwaddr.mac:"");$("#wanIp6Enable").prop("checked",d);$("#wanIp6").toggle(d);$("#wanIp6Addr").val(c.getIp6Addr());$("#wanIp6Netmask").val(c.getIp6Netmask());$("#wanIp6Gateway").val(c.getIp6Gateway());$("#wanIp6Dns1").val(c.getDns(2));$("#wanIp6Dns2").val(c.getDns(3));var a=g_cfg.netmode;if(!oldNetMode){oldNetMode=a}if(oldNetMode!==a&&(a==="soho"||a==="router")){$("#wanBlockMgmt").prop("checked",true)}},updateWanIfc:function(){if(!this.active){return}var a=g_net.wan.getDevname(),e=g_net.mlan.getDevname(),d=!g_net.advancedCfgMode()&&g_cfg.netmode=="router",g=d?[]:Array.prototype.slice.call(g_net.freeIfc,0),f=$("#wanIfc");g.push(a);if(d){for(var c in g_net.lan){if(g_net.lan.hasOwnProperty(c)){g.push(c)}}}else{if(a!=e){g.push(e)}}g.sort();f.children().remove();$.each(filterEnabledIfcs(g),function(h,i){var j=$("<option></option>").attr("value",i).text(ubnt.cfg.devname2uidevname(i));if(i==a){j.prop("selected",true)}f.append(j)})},updateMaxMtuTooltip:function(){if(!this.active){return}$("#wanMtu").prop("title","[64-"+g_net.getMaxMtu(g_net.wan.getDevname())+"]")},updateWanMaxMtuTooltip:function(){if(!this.active){return}$("#wanPppoeMtu").prop("title","[64-"+g_net.getWanMaxMtu(g_net.wan.getDevname())+"]");$("#wanPppoeMru").prop("title","[64-"+g_net.getWanMaxMtu(g_net.wan.getDevname())+"]")},isBridgeSelected:function(){return g_net.wan.getDevname().indexOf("br")==0}},dhcpReserv:{headerId:"#dhcpReserv",init:function(){var a=$("#dhcpReservErrDiv");$("#dhcpReserv_table").delegate("input.delDhcpReserv","click",function(){var c=$.tmplItem(this).data,d=g_cfg.dhcpd.findByDevname(c.devname,true);d.dhcpreserv.remove(c.dhcpreservObjRef);if($(this).closest("tr").find("#edtDhcpReservIp").length>0){$("#dhcpReserv_table").find(".editDhcpReserv, #dhcpReservAdd").prop("disabled",false)}$(this).closest("tr").remove();showErrors(a)}).delegate("input.editDhcpReserv","click",function(){$("#dhcpReserv_table").find(".editDhcpReserv, #dhcpReservAdd").prop("disabled",true);var c=$.tmplItem(this).data;$(this).closest("tr").replaceWith($("#dhcpReservEditTmpl").tmpl([c]))}).delegate("input.saveDhcpReserv","click",function(){var d=$.tmplItem(this).data,g=d.dhcpreservObjRef,e=g_cfg.dhcpd.findByDevname(d.devname,true);var c=e.dhcpreserv.create($("#edtDhcpReservMac").val(),$("#edtDhcpReservIp").val(),$("#edtDhcpReservComment").val(),g.enabled());var f=[];if(c.valid(f)){e.dhcpreserv.replace(g,c);d.dhcpreservObjRef=c;$(this).closest("tr").replaceWith($("#dhcpReservTmpl").tmpl([d]));$("#dhcpReserv_table").find(".editDhcpReserv, #dhcpReservAdd").prop("disabled",false)}showErrors(a,f)}).delegate("input.enableDhcpReserv","change",function(){$.tmplItem(this).data.dhcpreservObjRef.enabled(this.checked)});$("#dhcpReservAdd").click(function(){var d=g_cfg.dhcpd.findByDevname($("#dhcpReservIfc").val(),true);if(d){var c={devname:d.devname,dhcpreservObjRef:d.dhcpreserv.create($("#dhcpReservMac").val(),$("#dhcpReservIp").val(),$("#dhcpReservComment").val(),true)};var e=[];if(c.dhcpreservObjRef.valid(e)){d.dhcpreserv.add(c.dhcpreservObjRef);$("#dhcpReserv_table tfoot input[type=text]").val("");$("#dhcpReservTmpl").tmpl(c).appendTo("#dhcpReserv_table")}showErrors(a,e)}});g_net.bind("ifcUsed",$.proxy(this,"render")).bind("ifcUnused",$.proxy(this,"fillDevnames"))},render:function(){$("#dhcpReserv_table > tbody").empty();this.fillDevnames();$("#dhcpReservTmpl").tmpl(g_net.getIpdhcpReserv()).appendTo("#dhcpReserv_table")},getDhcpReservLans:function(){var a=[];$.each(g_net.lan,function(c,d){if(d.getDhcpServer()=="Enabled"){a.push(d.getDevname())}});return a},fillDevnames:function(){$("#dhcpReservIfc").children().remove();$.each(this.getDhcpReservLans(),function(a,c){$("#dhcpReservIfc").append($("<option></option>").attr("value",c).text(ubnt.cfg.devname2uidevname(c)))})}},lan:{headerId:"#headerLan",init:function(){var a=$("#lanIfc"),c=this;$("#lanAdd").click(function(){var g=$(this).siblings("#lanIfc"),e=g.val(),d=g_net.addLan(e);if(d){var f;c.updateLanIfc();f=$("#lanTmpl").tmpl(d,c.tmplFuncs).appendTo("#lanSettings");f.find('input.lanDhcp:radio[value="'+d.getDhcpServer()+'"]').click();c.updateIp6(f,d);c.updateMaxMtuTooltip()}});$("#lanSettings").delegate(".delLan","click",function(){var d=$.tmplItem(this).data;g_net.removeLan(d.getDevname());$(this).closest(".lanFields").remove();c.updateLanIfc()}).delegate(".lanDhcp","click",function(){var g=$(this),f=g.val(),e=g.closest(".lanFields"),d=g.tmplItem().data;e.find(".lanDhcpEnabled").hide();e.find(".lanDhcpRelay").hide();e.find(".lanDhcp"+f).show();d.setDhcpServer(f);if((d.getDhcpServer()=="Enabled")||(d.getDhcpServer()=="Relay")){c.fillDhcp(e,d)}c.toggleDhcpReserv()}).delegate(".lanDnsProxy","click",function(){var e=$(this);var d=e.closest(".lanFields");d.find(".lanDhcpDnsSection").toggle(!this.checked);d.find(".lanDhcpDns6Section").toggle(!this.checked)}).delegate(".lanIp6Enable","click",function(){var f=$(this),e=f.closest(".lanFields"),d=f.tmplItem().data;d.ip6Enable(this.checked);f.parent().next().toggle(this.checked)}).delegate(".lanIp6Mode","click",function(){var g=$(this),f=g.closest(".lanFields"),h=g.val(),e=g.tmplItem().data,d=e.getIp6PrefixLen();f.find(".lanIp6AddrSection").toggle(h==="Static");f.find(".lanIp6PrefixSection").toggle(h==="PD");f.find(".lanIp6DhcpSection").toggle(h==="Static"||h==="PD");f.find(".lanIp6PrefixLen").val(d);e.setLanIp6Mode(g_net.wan.dhcp6cObj,h,d)}).delegate(".lanDhcp6","click",function(){var g=$(this),e=g.val(),f=g.closest(".lanFields"),d=g.tmplItem().data;f.find(".lanDhcp6Stateless").hide();f.find(".lanDhcp6Stateful").hide();f.find(".lanDhcp6"+e).show();d.setDhcp6Server(e);c.fillDhcp6(f,d)}).delegate(".lanDhcpDns6Proxy","click",function(){var d=$(this);d.parent().next().toggle(!this.checked)});g_net.bind("ifcUsed ifcUnused ifcEnabled ifcDisabled",$.proxy(this,"updateLanIfc")).bind("bridgePortAdded bridgePortRemoved",$.proxy(this,"updateMaxMtuTooltip")).bind("wanIfcChanged",$.proxy(this,"render")).bind("ip6ModeChanged",$.proxy(this,"ip6ModeChanged"));$("#network").bind("beforeSubmit",function(){if(!c.active){return}var e=$("#lanSettings").find(".lanFields"),d=g_cfg.get("upnpd"),f=g_cfg.get("upnpd.listening");f.removeAll();d.enabled(false);e.each(function(){var k=$(this),j=k.tmplItem().data,i=k.find(".lanDnsProxy").prop("checked"),m=k.find(".lanIp6Enable").prop("checked"),g=$("input.lanIp6Mode:checked").val();j.setIp(k.find(".lanIpAddr").val(),k.find(".lanIpNetmask").val());j.dnsProxyEnabled(i);if(!g_net.advancedCfgMode()){g_net.setMtu(j.getDevname(),k.find(".lanMtu").val())}j.upnpdEnable(k.find(".lanUPnP").prop("checked"));switch(j.getDhcpServer()){case"Enabled":var h=j.dhcpdObj.dns;j.dhcpdObj.start=k.find(".lanDhcpStart").val();j.dhcpdObj.end=k.find(".lanDhcpEnd").val();j.dhcpdObj.netmask=k.find(".lanDhcpNetmask").val();j.dhcpdObj.lease_time=k.find(".lanDhcpLeaseTime").val();j.dhcpdObj.dnsproxy=i?"enabled":"disabled";h.objs[0].status=h.objs[1].status=i?"disabled":"enabled";if(!i){h.objs[0].server=k.find(".lanDhcpDns1").val();h.objs[1].server=k.find(".lanDhcpDns2").val()}break;case"Relay":j.dhcpRelayServerObj.devname=g_net.wan.getDevname();j.dhcpRelayServerObj.ip=k.find(".lanDhcpSrvIp").val();j.dhcpRelayClientObj.agentid=k.find(".lanDhcpAgent").val();break}if(j.getDhcp6Server()=="Stateless"||j.getDhcp6Server()=="Stateful"){var l=j.dhcp6dObj.dns;j.dhcp6dObj.dnsproxy=i?"enabled":"disabled";l.objs[0].status=i?"disabled":"enabled";if(!i){l.objs[0].server=k.find(".lanDhcpDns6").val()}else{l.objs[0].server=""}}j.ip6Enable(m);if(!m||g==="Local"){j.setDhcp6Server("Disabled")}else{if(g==="Static"){j.setIp6(k.find(".lanIp6Addr").val(),k.find(".lanIp6Netmask").val())}else{if(g==="PD"){j.setIp6PrefixLen(k.find(".lanIp6PrefixLen").val())}}}})})},render:function(){var d=$("#lanSettings"),c=g_net.advancedCfgMode(),a=g_cfg.netmode=="router",f=this.getLans(),e=this;this.updateLanIfc();d.children().remove();$("#lanTmpl").tmpl(f,this.tmplFuncs).appendTo(d);d.find(".lanFields").each(function(){var h=$(this),g=h.tmplItem().data;h.find('input.lanDhcp:radio[value="'+g.getDhcpServer()+'"]').click();e.updateIp6(h,g)}).find(".lanIfcSection").toggle(c||a).find(".delLan").toggle(c);this.updateMaxMtuTooltip();$("#addLanSection").toggle(c)},getLans:function(){var c=[];for(var a in g_net.lan){if(g_net.lan[a].enabled()){c.push(g_net.lan[a])}}return c},toggleDhcpReserv:function(){views.dhcpReserv.active=false;$.each(this.getLans(),function(c,a){if(a.getDhcpServer()=="Enabled"){views.dhcpReserv.active=true;return true}});toggleView("dhcpReserv")},valid:function(){var c=$("#lanSettings").find(".lanFields"),a=true;c.each(function(){var g=[],d=$(this),k=d.tmplItem().data,l=g_net.getMaxMtu(k.getDevname()),j=d.find(".lanIp6Enable").prop("checked"),i=$("input.lanIp6Mode:checked").val(),e=$("#wanSettings input:radio[name=wanIp6Mode]:checked").val(),h=$("#wanIp6Enable").prop("checked");var f=d.find(".lanDnsProxy").prop("checked");validateFieds(d,[{name:jsTranslate("LAN IP address"),field:".lanIpAddr",req:true,valid:_validateNonZeroIP},{name:jsTranslate("LAN Netmask"),field:".lanIpNetmask",req:true,valid:_validateNetmask},{name:jsTranslate("LAN MTU"),field:".lanMtu",req:true,min:64,max:l}],g);switch(k.getDhcpServer()){case"Enabled":validateFieds(d,[{name:jsTranslate("DHCP Range Start"),field:".lanDhcpStart",req:true,valid:_validateNonZeroIP},{name:jsTranslate("DHCP Range End"),field:".lanDhcpEnd",req:true,valid:_validateNonZeroIP},{name:jsTranslate("DHCP Netmask"),field:".lanDhcpNetmask",req:true,valid:_validateNetmask},{name:jsTranslate("DHCP Lease Time"),field:".lanDhcpLeaseTime",req:true,min:120,max:172800}],g);if(!f){validateFieds(d,[{name:jsTranslate("DHCP Primary DNS IP"),field:".lanDhcpDns1",req:false,valid:_validateNonZeroIP},{name:jsTranslate("DHCP Secondary DNS IP"),field:".lanDhcpDns2",req:false,valid:_validateNonZeroIP}],g)}break;case"Relay":validateFieds(d,[{name:jsTranslate("DHCP Server"),field:".lanDhcpSrvIp",req:true,valid:_validateNonZeroIP}],g);break}if(j&&!f){validateFieds(d,[{name:jsTranslate("IPv6 Preferred DNS"),field:".lanDhcpDns6",req:false,valid:_validateIP6}],g)}if(j&&i=="Static"){validateFieds(d,[{name:jsTranslate("IPv6 Address"),field:".lanIp6Addr",req:true,valid:_validateIP6},{name:jsTranslate("IPv6 Netmask"),field:".lanIp6Netmask",req:true,valid:_validateIP6Netmask}],g)}if(j&&h&&i=="PD"&&e=="Ip6Dhcp6"){validateFieds(d,[{name:jsTranslate("IPv6 Prefix Length"),field:".lanIp6PrefixLen",req:true,min:0,max:64,valid:_validateIP6PrefixLen}],g)}showErrors(d.find(".errors"),g);a=a&&(g.length==0)});return a},fillDhcp:function(c,m){var i=false;var d=c.find(".lanDnsProxy").prop("checked");if(m.getDhcpServer()=="Enabled"){var l=m.netconfObj.getIdx();var e="#lanIpAddr"+l;var k="#lanIpNetmask"+l;var j=$(e).val();var g=$(k).val();var n=ipSubnetCalc.toDec(j);var h=ipSubnetCalc.toDec(g);var a=ipSubnetCalc.toDec(m.getDhcpdAttr("start",false));i=(n&h)!=(a&h)}c.find(".lanDhcpStart").val(m.getDhcpdAttr("start",i,j,g));c.find(".lanDhcpEnd").val(m.getDhcpdAttr("end",false));c.find(".lanDhcpNetmask").val(m.getDhcpdAttr("netmask",false));c.find(".lanDhcpLeaseTime").val(m.getDhcpdAttr("lease_time",false));c.find(".lanDhcpDnsSection").toggle(!d);if(m.dhcpdObj&&m.dhcpdObj.dns){var f=m.dhcpdObj.dns;if(f&&f.objs.length>0){c.find(".lanDhcpDns1").val(f.objs[0].server)}if(f&&f.objs.length>1){c.find(".lanDhcpDns2").val(f.objs[1].server)}}if(m.dhcpRelayServerObj){c.find(".lanDhcpSrvIp").val(m.dhcpRelayServerObj.ip)}if(m.dhcpRelayClientObj){c.find(".lanDhcpAgent").val(m.dhcpRelayClientObj.agentid)}},fillDhcp6:function(d,c){var a=d.find(".lanDnsProxy").prop("checked");if(c.dhcp6dObj&&c.dhcp6dObj.dns){var e=c.dhcp6dObj.dns;d.find(".lanDhcpDns6Section").toggle(!a);if(e&&e.objs.length>0){d.find(".lanDhcpDns6").val(e.objs[0].server)}}},updateLanIfc:function(){if(!this.active){return}var a=$("#lanIfc");a.children().remove();$.each(filterEnabledIfcs(g_net.freeIfc),function(c,d){var e=$("<option></option>").attr("value",d).text(ubnt.cfg.devname2uidevname(d));a.append(e)});a.prop("disabled",g_net.freeIfc.length==0);$("#lanAdd").prop("disabled",g_net.freeIfc.length==0)},tmplFuncs:{genId:function(a){return a+this.data.netconfObj.getIdx()}},updateMaxMtuTooltip:function(){if(!this.active){return}var a=$("#lanSettings").find(".lanFields");a.each(function(){var d=$(this),c=d.tmplItem().data;$(".lanMtu").prop("title","[64-"+g_net.getMaxMtu(c.getDevname())+"]")})},updateIp6:function(d,c){var e=c.ip6Enabled();var a=g_net.wan.getIp6Mode()=="Ip6Dhcp6";d.find(".lanIp6Enable").prop("checked",e);d.find(".lanIp6").toggle(e);d.find(".lanIp6Addr").val(c.getIp6Addr());d.find(".lanIp6Netmask").val(c.getIp6Netmask());d.find('input.lanIp6Mode:radio[value="'+c.getLanIp6Mode(g_net.wan.dhcp6cObj)+'"]').click();d.find('input.lanIp6Mode:radio[value="PD"]').toggle(a).next().toggle(a);d.find('input.lanDhcp6:radio[value="'+c.getDhcp6Server()+'"]').click();d.find(".lanIp6PrefixLen").val(c.getIp6PrefixLen());d.find(".lanIp6PrefixLen").prop("title","[0-64]")},ip6ModeChanged:function(){var a=this;var c=$("#lanSettings").find(".lanFields");c.each(function(){var e=$(this),d=e.tmplItem().data;a.updateIp6(e,d)})}},mlan:{headerId:"#headerMgmt",init:function(){var a=$("#mgmtIfc"),c=this;g_net.bind("ifcUsed ifcUnused ifcEnabled ifcDisabled",this.updateMlanIfc);g_net.bind("bridgePortAdded bridgePortRemoved",$.proxy(this,"updateMaxMtuTooltip"));$("[name=mgmtIpMode]").click(function(){$("#mgmtStatic").hide();$("#mgmtDhcpc").hide();$("#mgmt"+$(this).val()).show()});$("[name=mgmtIp6Mode]").click(function(){var d=$(this).val();c.renderIp6(d);g_net.mlan.setIp6Mode(d,true)});a.change(function(){g_net.setMlanIfc($(this).val());c.render()});$("#mgmtVlanEnable").click(function(){$("#mgmtVlanIdSection").toggle(this.checked)});g_net.bind("wanIfcChanged",function(){a.change()});$("#mgmtIp6Enable").click(function(){$("#mgmtIp6").toggle(this.checked)});$("#network").bind("beforeSubmit",function(){if(g_net.mlan.enabled()){var f=$("#mgmtSettings input:radio[name=mgmtIpMode]:checked").val(),k=$("#mgmtSettings input:radio[name=mgmtIp6Mode]:checked").val(),g=g_net.mlan,e=g_net.isBridge,j=$("#mgmtIp6Enable").prop("checked");g.setIpMode(f,e);if(f=="Static"){g.setIp($("#mgmtIpAddr").val(),$("#mgmtIpNetmask").val());if(g_net.isBridge){g.setGateway($("#mgmtGateway").val());g.setDns(0,$("#mgmtDns1").val());g.setDns(1,$("#mgmtDns2").val())}}else{if(f=="Dhcpc"){g.setDhcpcFallback($("#mgmtDhcpcFallbackIp").val(),$("#mgmtDhcpcFallbackNetmask").val())}}g.netconfObj.autoip.enabled($("#mgmtAutoIp").prop("checked"));if(!g_net.advancedCfgMode()){var i;g_net.setMtu("br0",$("#mgmtMtu").val());g_net.setMgmtVlan($("#mgmtVlanEnable").prop("checked")?$("#mgmtVlanId").val():"");if($("#mgmtVlanEnable").prop("checked")){var h=$("#mgmtMtu").val();var d=g_net.getMaxMtu("br1");h=h>d?d:h;g_net.setMtu("br1",h,true)}i=g_cfg.bridge.findByDevname(g.netconfObj.getDevname());if(i){i.stp.enabled($("#mgmtStp").prop("checked"))}}g.ip6Enable(j);if(j){g.setIp6Mode(k);if(k=="Ip6Static"){g.setIp6($("#mgmtIp6Addr").val(),$("#mgmtIp6Netmask").val())}}}})},render:function(){var a=g_net.advancedCfgMode(),c=g_net.mlan.enabled();$("#mgmtIfcSection").toggle(a);if(a){this.updateMlanIfc()}$("#mgmtDetails").toggle(c);if(c){this.fillData(g_net.mlan);this.updateMaxMtuTooltip();this.renderIp6(g_net.mlan.getIp6Mode())}},renderIp6:function(a){$("input:radio[name=mgmtIp6Mode][value="+a+"]").prop("checked",true);$("#mgmtIp6 .initial_hide").hide();$("#mgmt"+a).show()},valid:function(){if(!g_net.mlan.enabled()){return true}var c=[],a=$("#mgmtSettings");ipMode=$("#mgmtSettings input:radio[name=mgmtIpMode]:checked").val(),maxMtu=g_net.getMaxMtu("eth0"),ip6Enabled=$("#mgmtIp6Enable").prop("checked"),ip6Mode=$("#mgmtSettings input:radio[name=mgmtIp6Mode]:checked").val();if(!g_net.advancedCfgMode()&&$("#mgmtVlanEnable").prop("checked")){g_cfg.get("vlan").create("eth0",$("#mgmtVlanId").val(),"").valid(c)}if(ipMode=="Static"){validateFieds(a,[{name:jsTranslate("IP Address"),field:"#mgmtIpAddr",req:true,valid:_validateNonZeroIP},{name:jsTranslate("IP Netmask"),field:"#mgmtIpNetmask",req:true,valid:_validateNetmask}],c);if(g_net.isBridge){validateFieds(a,[{name:jsTranslate("Gateway IP"),field:"#mgmtGateway",req:true,valid:_validateNonZeroIP},{name:jsTranslate("Primary DNS IP"),field:"#mgmtDns1",req:false,valid:_validateNonZeroIP},{name:jsTranslate("Secondary DNS IP"),field:"#mgmtDns2",req:false,valid:_validateNonZeroIP}],c)}}else{if(ipMode=="Dhcpc"){validateFieds(a,[{name:jsTranslate("DHCP Fallback IP"),field:"#mgmtDhcpcFallbackIp",req:true,valid:_validateIP},{name:jsTranslate("DHCP Fallback Netmask"),field:"#mgmtDhcpcFallbackNetmask",req:true,valid:_validateNetmask}],c)}}if(!g_net.advancedCfgMode()){validateFieds(a,[{name:jsTranslate("MTU"),field:"#mgmtMtu",req:true,min:64,max:maxMtu,valid:_validateNumbersOnly}],c)}if(ip6Enabled&&ip6Mode=="Ip6Static"){validateFieds(a,[{name:jsTranslate("IPv6 Address"),field:"#mgmtIp6Addr",req:true,valid:_validateIP6},{name:jsTranslate("IPv6 Netmask"),field:"#mgmtIp6Netmask",req:true,valid:_validateIP6Netmask}],c)}showErrors(a.find(".errors"),c);return(c.length==0)},fillData:function(e){var d=e.getIpMode(),c=g_net.advancedCfgMode(),g=e.ip6Enabled();$("input:radio[name=mgmtIpMode]").filter('[value="'+d+'"]').click();$("#mgmtVlanSection, #mgmtStpSection").toggle(!c);if(!c){var a=g_net.getMgmtVlan();$("#mgmtVlanEnable").prop("checked",!!a);$("#mgmtVlanIdSection").toggle(!!a);$("#mgmtVlanId").val(a);var f=g_cfg.bridge.findByDevname(e.netconfObj.getDevname());if(f){$("#mgmtStp").prop("checked",f.stp.enabled())}}$("#mgmtIpAddr").val(e.netconfObj.ip);$("#mgmtIpNetmask").val(e.netconfObj.netmask);if(g_net.isBridge){$("#mgmtGateway").val(e.getGateway());$("#mgmtDns1").val(e.getDns(0));$("#mgmtDns2").val(e.getDns(1))}$("#mgmtGatewayDns").toggle(g_net.isBridge);$("#mgmtDhcpcFallbackIp").val(e.getDhcpcFallback());$("#mgmtDhcpcFallbackNetmask").val(e.getDhcpcFallbackNetmask());$("#mgmtMtu").val(g_net.getMtu("eth0"));$("#mgmtAutoIp").prop("checked",e.netconfObj.autoip.enabled());$("#mgmtIp6Enable").prop("checked",g);$("#mgmtIp6").toggle(g);$("#mgmtIp6Addr").val(e.getIp6Addr());$("#mgmtIp6Netmask").val(e.getIp6Netmask())},updateMlanIfc:function(){var c=$("#mgmtIfc"),d=g_net.mlan.getDevname(),a=!g_net.isBridge?g_net.wan.getDevname():d,e=Array.prototype.slice.call(g_net.freeIfc,0);e.push(d);if(a!=d){e.push(a)}e.sort();c.children().remove();$.each(filterEnabledIfcs(e),function(f,g){var h=$("<option></option>").attr("value",g).text(ubnt.cfg.devname2uidevname(g));if(g==d){h.prop("selected",true)}c.append(h)})},updateMaxMtuTooltip:function(){if(!this.active){return}$("#mgmtMtu").prop("title","[64-"+g_net.getMaxMtu("eth0")+"]")}},igmp:{headerId:"#headerIgmp",init:function(){var a=this;$("#igmpEnable").change(function(){var c=g_cfg.igmpproxy;c.enabled(this.checked);if(c.upstream.devname===undefined){c.upstream.devname=g_net.wan.getDevname()}a.render()});$("#igmpUpstream").change(function(){g_cfg.igmpproxy.upstream.devname=$(this).val();a.updateIfcDropdowns()});$("#igmpDownstreamAdd").change(function(){var c=$(this).val();if(c=="add"){return}g_cfg.igmpproxy.add(g_cfg.igmpproxy.create(c,true));$("#igmpDownstream").append($("<option></option>").attr("value",c).text(ubnt.cfg.devname2uidevname(c)));$(this).val("add");a.updateIfcDropdowns()});$("#igmpDownstreamDel").click(function(){var c=$("#igmpDownstream").children("option:selected");devnames=[];c.each(function(d,e){devnames.push(e.value)});c.remove();a.removeDownstream(devnames);a.updateIfcDropdowns()});g_net.bind("ifcRemoved",function(c){if(c===g_cfg.get("igmpproxy.upstream").devname){g_cfg.igmpproxy.enabled(false)}else{a.removeDownstream([c])}a.render()}).bind("ifcUsed ifcUnused ifcAdded ifcRemoved",$.proxy(this,"updateIfcDropdowns"))},render:function(){var c=g_cfg.get("igmpproxy"),a=c.enabled();$("#igmpEnable").prop("checked",a);$("#igmpSettings").toggle(a);if(a){var d=$("#igmpDownstream");this.updateIfcDropdowns();d.children().remove();$.each(this.getDownstreamIfcs(),function(e,f){$("<option></option>").attr("value",f).text(ubnt.cfg.devname2uidevname(f)).appendTo(d)})}},getDownstreamIfcs:function(){var a=[];g_cfg.get("igmpproxy").each(function(d,c){a.push(c.downstream.devname)});return a},getIfcsForUpstream:function(){var c=this.getDownstreamIfcs(),a=g_cfg.bridge.getPorts();return $.grep(g_net.interfaces,function(d){return $.inArray(d,c)==-1&&$.inArray(d,a)==-1})},getIfcsForDownstream:function(){var c=this.getIfcsForUpstream(),a=g_cfg.get("igmpproxy").upstream.devname,d=$.inArray(a,c);if(d!=-1){c.splice(d,1)}return c},updateIfcDropdowns:function(){var a=g_cfg.get("igmpproxy").upstream.devname,d=$("#igmpUpstream"),c=$("#igmpDownstreamAdd");d.children().remove();$.each(this.getIfcsForUpstream(),function(e,f){var g=$("<option></option>").attr("value",f).text(ubnt.cfg.devname2uidevname(f));if(f==a){g.prop("selected",true)}d.append(g)});c.children('option[value!="add"]').remove();$.each(this.getIfcsForDownstream(),function(e,f){var g=$("<option></option>").attr("value",f).text(ubnt.cfg.devname2uidevname(f));c.append(g)})},removeDownstream:function(c){var a=g_cfg.get("igmpproxy");a.objs=a.grep(function(d){return $.inArray(d.downstream.devname,c)==-1})},valid:function(){var e=[];lans=[];for(var d in g_net.lan){if(g_net.lan[d].enabled()){lans.push(g_net.lan[d])}}var c=g_cfg.get("igmpproxy"),a=c.enabled();if(a&&lans.length==0){e.push(jsTranslate("warn_multi_lan_ifc|Multicast Routing requires at least one configured LAN interface."))}if(a&&this.getDownstreamIfcs().length==0){e.push(jsTranslate("warn_multi_down_ifc|Please specify Multicast Downstream interface."))}showErrors($("#igmpErrDiv"),e);return(e.length==0)}},trafficShaping:{headerId:"#headerTShaping",init:function(){var c=$("#tshapingErrDiv"),a=this;$("#tshaping_table").delegate("input.delTShaping","click",function(){var e=$.tmplItem(this).data;g_cfg.tshaper.remove(e);if($(this).closest("tr").find("#edtTSOutBurst").length>0){$("#tshaping_table").find(".editTShaping, #tshapingAdd").prop("disabled",false)}$(this).closest("tr").remove();showErrors(c);var d=$("#tshapingAdd").prop("disabled");a.fillDevnames();$("#tshapingAdd").prop("disabled",d)}).delegate("input.editTShaping","click",function(){$("#tshaping_table").find(".editTShaping, #tshapingAdd").prop("disabled",true);var d=$.tmplItem(this).data;$(this).closest("tr").replaceWith($("#tshapingEditTmpl").tmpl([d]))}).delegate("input.saveTShaping","click",function(){var e=$.tmplItem(this).data;var d=g_cfg.tshaper.create(e.devname,$("#edtTSInEnable").prop("checked"),$("#edtTSInRate").val(),$("#edtTSInBurst").val(),$("#edtTSOutEnable").prop("checked"),$("#edtTSOutRate").val(),$("#edtTSOutBurst").val(),e.enabled);var f=[];if(d.valid(f)){g_cfg.tshaper.replace(e,d);$(this).closest("tr").replaceWith($("#tshapingTmpl").tmpl([d]));$("#tshaping_table").find(".editTShaping, #tshapingAdd").prop("disabled",false)}showErrors(c,f)}).delegate("input.enableTShaping","change",function(){$.tmplItem(this).data.enabled(this.checked)}).delegate("#edtTSInEnable","change",function(){var d=!$(this).prop("checked");$("#edtTSInRate").prop("disabled",d);$("#edtTSInBurst").prop("disabled",d)}).delegate("#edtTSOutEnable","change",function(){var d=!$(this).prop("checked");$("#edtTSOutRate").prop("disabled",d);$("#edtTSOutBurst").prop("disabled",d)});$("#tshapingInEnable").change(function(){var d=!$(this).prop("checked");$("#tshapingInRate").prop("disabled",d);$("#tshapingInBurst").prop("disabled",d)});$("#tshapingOutEnable").change(function(){var d=!$(this).prop("checked");$("#tshapingOutRate").prop("disabled",d);$("#tshapingOutBurst").prop("disabled",d)});$("#tshapingAdd").click(function(){var d=g_cfg.tshaper.create($("#tshapingIfc").val(),$("#tshapingInEnable").prop("checked"),$("#tshapingInRate").val(),$("#tshapingInBurst").val(),$("#tshapingOutEnable").prop("checked"),$("#tshapingOutRate").val(),$("#tshapingOutBurst").val(),true);var e=[];if(d.valid(e)){g_cfg.tshaper.add(d);$("#tshaping_table tfoot input[type=text]").val("");$("#tshapingTmpl").tmpl(d).appendTo("#tshaping_table");a.fillDevnames()}showErrors(c,e)});$("#tshapingEnable").change(function(){var d=this.checked;g_cfg.get("tshaper").enabled(d);$("#tshaping_table").toggle(d)});g_net.bind("ifcUsed",this.fillDevnames).bind("ifcUnused",this.fillDevnames)},render:function(){var a=g_cfg.get("tshaper"),c=a.enabled();$("#tshapingEnable").prop("checked",c);$("#tshaping_table > tbody").empty();$("#tshaping_table").toggle(c);this.fillDevnames();$("#tshapingTmpl").tmpl(g_cfg.get("tshaper").objs).appendTo("#tshaping_table")},fillDevnames:function(){var c=g_cfg.getInterfaces(["tshaper"]),d=$.grep(g_cfg.getInterfaces(["board","vlan"]),function(e){return $.inArray(e,c)==-1}),a=$("#tshapingIfc");d.sort();a.children().remove();$.each(d,function(e,f){a.append($("<option></option>").attr("value",f).text(ubnt.cfg.devname2uidevname(f)))});$("#tshapingAdd").prop("disabled",d.length==0)}},cfgMode:{init:function(){$("#cfgmode").change(function(d){var c=$(this);if(c.val()=="advancedMode"){$("#network").trigger("beforeSubmit");g_net.setAdvancedCfgMode(true);renderViews()}else{$("#network").trigger("beforeSubmit");if(!g_net.simpleCfgModeApplicable()){var f=jsTranslate("warn_net_switch_erase|Warning: Changing to Simple mode will erase all current advanced networking settings (bridge/vlan/etc).");if(!confirm(f)){c.val("advancedMode");return}var a=g_net.evFns;g_cfg=g_net.switchNetmode(g_cfg.netmode);delete g_cfg.vlan;g_net=ubnt.net.network(g_cfg);g_net.evFns=a}else{if(g_cfg.tshaper&&g_cfg.tshaper.enabled()){g_cfg.tshaper.enabled(false)}}g_net.setAdvancedCfgMode(false);renderViews()}})},render:function(){var a=g_net.advancedCfgMode();$("#cfgmode").val(a?"advancedMode":"simpleMode")}}};function showErrors(e,d){var c=[];if(d&&d.length>0){for(var a=0;a<d.length;++a){if(c.length>0){c.push("<br/>")}if(d[a].length>0){c.push(d[a])}}}e.html(c.join("")).toggle(c.length>0)}function filterEnabledIfcs(a){return $.grep(a,function(c){return !!g_cfg.netconf.findByDevname(c,true)})}function quickFixForSinglePortDevices(){if(g_board.board.phycount>1){return}$.each(g_cfg.netconf.find({devname:"eth1"}),function(d,c){g_cfg.netconf.remove(c)});$.each(g_cfg.bridge.objs,function(c,d){var e=d.port.find({devname:"eth1"});$.each(e,function(f,g){d.port.remove(g)})});var a=g_cfg.get("vlan").find({devname:"eth1"});if(a.length){$.each(a,function(f,e){var g=e.getFullDevname(),d=g_cfg.get("netconf").find({devname:g}),c=g_cfg.get("ebtables.sys.vlan"),h=c.find({devname:e.devname,id:e.id});g_cfg.vlan.remove(e);$.each(g_cfg.bridge.objs,function(i,k){var j=k.port.find({devname:g});$.each(j,function(l,m){k.port.remove(m)})});$.each(d,function(j,i){g_cfg.netconf.remove(i)});$.each(h,function(i,j){c.remove(j)});c.enabled(c.objs.length)})}}function initViews(){$.each(views,function(a,c){c.init()})}function renderViews(){var i={bridge:{simple:["netmode","disableNet","mlan","cfgMode"],advanced:["netmode","disableNet","mlan","ifaces","aliases","vlan","bridge","firewall","firewall6","routes","trafficShaping","cfgMode"]},router:{simple:["netmode","disableNet","wan","lan","portForward","igmp","cfgMode"],advanced:["netmode","disableNet","wan","lan","mlan","ifaces","aliases","vlan","bridge","firewall","firewall6","routes","routes6","portForward","igmp","trafficShaping","cfgMode"]},soho:{simple:["netmode","disableNet","wan","lan","portForward","igmp","cfgMode"],advanced:["netmode","disableNet","wan","lan","mlan","ifaces","aliases","vlan","bridge","firewall","firewall6","routes","routes6","portForward","igmp","trafficShaping","cfgMode"]}},h=i[g_cfg.netmode][g_net.advancedCfgMode()?"advanced":"simple"],d=($.cookie("netCollapsed")||"#headerIfaces,#headerVlan,#headerBridge,#headerFirewall,#headerFirewall6,#headerRoutes,#headerRoutes6,#headerPortFwd,#headerAliases,#headerIgmp,#headerTShaping,#dhcpReserv").split(",");for(var g in views){var f=$.inArray(g,h)!=-1,a=views[g];a.active=f;if(a.headerId){var c=$.inArray(a.headerId,d)!=-1,e=$(a.headerId);e.toggle(f).next().toggle(f&&!c);if(c){e.addClass("active")}}if(f){a.render()}}$(".simple-only").toggle(!g_net.advancedCfgMode());$("a[rel=help]").click(helpClick)}function toggleView(e){var a=views[e];var d=$(a.headerId);collapsedViews=($.cookie("netCollapsed")||"#dhcpReserv").split(",");var c=$.inArray(a.headerId,collapsedViews)!=-1;d.toggle(a.active).next().toggle(a.active&&!c);if(c){d.addClass("active")}if(a.active){a.render()}}function validateFieds(d,a,c){$.each(a,function(e,g){var h=d.find(g.field).val();if(g.req&&!h){c.push(g.name+" "+jsTranslate("cannot be empty."))}else{if(h){if(g.valid&&!g.valid(h)){c.push(g.name+" "+jsTranslate("is invalid."))}else{if(g.min||g.max){var f=parseInt(h);if((g.min&&f<g.min)||(g.max&&f>g.max)){c.push(g.name+" "+jsTranslate("is out of range")+" ["+g.min+"-"+g.max+"].")}}}}}})}function viewsValid(){var c=true,a;$.each(views,function(d,e){if(e.active&&e.valid){if(!e.valid()){c=false;$(e.headerId).removeClass("active").next().show()}}});a=$(".errors:visible");if(!c&&a.length){$("html,body").scrollTop(a.offset().top)}return c}function getConfiguration(){$.ajax({url:"getcfg.sh",data:".",type:"GET",dataType:"text",success:function(a){g_cfg=ubnt.cfg.parse(a);if(!g_cfg.bridge){g_cfg.bridge=$.extend(true,{},ubnt.cfg.objPrototypes.base,ubnt.cfg.objPrototypes.bridge)}quickFixForSinglePortDevices();g_net=ubnt.net.network(g_cfg);$("#netmode").val(g_cfg.netmode);initViews();renderViews()},error:function(c,a){alert(jsTranslate("Failed!"))}})}$(document).ready(function(){$("h2.trigger").click(function(){var a="";$(this).toggleClass("active").next().slideToggle("fast");$(".active").each(function(){a=a+(a?",#":"#")+this.id});$.cookie("netCollapsed",a);return false});$(".pwd").attr("autocomplete","off").passwd({label:jsTranslate("Show"),migrate_attrs:["maxLength"]}).next().next().css("text-align","left");$.ajax({url:"getboardinfo.sh",type:"GET",dataType:"text",success:function(a){g_board=ubnt.cfg.parse(a);getConfiguration()},error:function(c,a){alert(jsTranslate("Failed!"))}});$("#show_cfg").click(function(){$("#network").trigger("beforeSubmit");g_net.updateStatuses();$("#debug_cfg").html(ubnt.cfg.toCfg(g_cfg).join("<br />"))});$("#network").submit(function(){try{var c=$("#wanBlockMgmt").prop("checked"),a=g_cfg.netmode;if(c&&(oldNetMode!==a)&&(a==="soho"||a==="router")){if(confirm(jsTranslate("Please confirm.\nManagement access is disabled on WAN interface. Continue?"))){$("#network").trigger("beforeSubmit");if(viewsValid()){g_net.updateStatuses();$("#network_data").val(ubnt.cfg.toCfg(g_cfg).join("\r\n"));return true}}}else{$("#network").trigger("beforeSubmit");if(viewsValid()){g_net.updateStatuses();$("#network_data").val(ubnt.cfg.toCfg(g_cfg).join("\r\n"));return true}}}catch(d){alert(jsTranslate("An error has occurred")+": "+d.message)}return false});fwUpdateCheck(false,fw_check);security.check()});